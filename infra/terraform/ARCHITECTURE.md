# 🏗️ アーキテクチャ図解

このドキュメントでは、Terraformで構築されるAWSインフラの全体像を図解で説明します。

## 📊 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────┐
│                           Internet                                   │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                ┌───────────────┴───────────────┐
                │                               │
         ┌──────▼────────┐             ┌───────▼────────┐
         │   Route53     │             │   Route53      │
         │ (DNS - api)   │             │ (DNS - www)    │
         └──────┬────────┘             └───────┬────────┘
                │                               │
         ┌──────▼────────┐             ┌───────▼────────┐
         │     ALB       │             │  AWS Amplify   │
         │  (Backend)    │             │  (Frontend)    │
         └──────┬────────┘             │   Next.js      │
                │                      └────────────────┘
         ┌──────▼────────────────────┐
         │  Target Group (ECS Tasks) │
         └──────┬────────────────────┘
                │
┌───────────────┴────────────────────────────────────────────────┐
│                         VPC (10.0.0.0/16)                      │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │          Public Subnet (10.0.0.0/24)                    │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐              │  │
│  │  │   ALB    │  │   NAT    │  │Internet  │              │  │
│  │  │          │  │ Gateway  │  │ Gateway  │              │  │
│  │  └──────────┘  └────┬─────┘  └────┬─────┘              │  │
│  └─────────────────────┼─────────────┼─────────────────────┘  │
│                        │             │                         │
│  ┌─────────────────────▼─────────────────────────────────┐    │
│  │       Private Subnet (10.0.10.0/24)                   │    │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐      │    │
│  │  │ ECS Task 1 │  │ ECS Task 2 │  │ ECS Task N │      │    │
│  │  │  (Fargate) │  │  (Fargate) │  │  (Fargate) │      │    │
│  │  │   Rust     │  │   Rust     │  │   Rust     │      │    │
│  │  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘      │    │
│  └────────┼───────────────┼───────────────┼─────────────┘    │
│           │               │               │                   │
│  ┌────────▼───────────────▼───────────────▼─────────────┐    │
│  │       Database Subnet (10.0.20.0/24)                 │    │
│  │  ┌──────────────────────────────────────────────┐    │    │
│  │  │      RDS PostgreSQL (Multi-AZ)               │    │    │
│  │  │  ┌────────────┐      ┌────────────┐          │    │    │
│  │  │  │  Primary   │◄────►│  Standby   │          │    │    │
│  │  │  │ (Active)   │      │ (Passive)  │          │    │    │
│  │  │  └────────────┘      └────────────┘          │    │    │
│  │  └──────────────────────────────────────────────┘    │    │
│  └───────────────────────────────────────────────────────┘    │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

## 🔄 データフロー

### 1. ユーザーがフロントエンドにアクセス

```
ユーザー
  ↓
Route53 (DNS解決: dev.yourdomain.com)
  ↓
AWS Amplify (Next.js SSR)
  ↓ (ページ表示)
ユーザーのブラウザ
```

### 2. フロントエンドからバックエンドAPIを呼び出し

```
Next.js (Browser)
  ↓ HTTPS
Route53 (DNS解決: api-dev.yourdomain.com)
  ↓
ALB (ロードバランサー)
  ↓ HTTP (内部通信)
ECS Fargate (Rustバックエンド)
  ↓ PostgreSQL Protocol
RDS PostgreSQL
  ↓ (データ取得)
ECS Fargate
  ↓ JSON
ALB
  ↓ HTTPS
Next.js (Browser)
  ↓ (表示)
ユーザー
```

## 🔐 セキュリティレイヤー

```
┌─────────────────────────────────────────────────────────┐
│  Layer 7: WAF (Web Application Firewall)                │
│  - SQLインジェクション対策                                │
│  - XSS対策                                               │
│  - レート制限（DDoS対策）                                │
└─────────────────┬───────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────┐
│  Layer 4: Security Groups (Firewall)                    │
│  ┌────────────────────────────────────────────────┐     │
│  │ ALB SG: 0.0.0.0/0:443 → ALB                    │     │
│  │ Backend SG: ALB → ECS:8000                     │     │
│  │ Database SG: ECS → RDS:5432                    │     │
│  └────────────────────────────────────────────────┘     │
└─────────────────┬───────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────┐
│  Network Layer: VPC & Subnets                           │
│  - Public: インターネット公開リソース                    │
│  - Private: 内部リソース（NAT経由でインターネット）     │
│  - Database: 完全に隔離（内部からのみアクセス可能）     │
└─────────────────┬───────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────┐
│  Data Layer: Encryption at Rest                         │
│  - RDS: AES-256 暗号化                                   │
│  - Secrets Manager: KMS暗号化                            │
│  - CloudWatch Logs: 暗号化                               │
└─────────────────────────────────────────────────────────┘
```

## 🚦 トラフィック制御

### Auto Scaling（自動スケーリング）

```
┌────────────────────────────────────────────────────────┐
│  CloudWatch Metrics                                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│  │   CPU    │  │  Memory  │  │ Requests │            │
│  │   70%    │  │   80%    │  │  /sec    │            │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘            │
│       │             │             │                    │
│       └─────────────┴─────────────┘                    │
│                     │                                  │
│           ┌─────────▼─────────┐                        │
│           │  Auto Scaling     │                        │
│           │  Target Tracking  │                        │
│           └─────────┬─────────┘                        │
└─────────────────────┼─────────────────────────────────┘
                      │
        ┌─────────────┴─────────────┐
        │                           │
  ┌─────▼─────┐             ┌──────▼──────┐
  │ Scale Out │             │  Scale In   │
  │ (増やす)   │             │  (減らす)   │
  └─────┬─────┘             └──────┬──────┘
        │                           │
  ┌─────▼──────────────────────────▼─────┐
  │   ECS Service (Desired Count)         │
  │   Min: 1  →  Current: 3  →  Max: 10   │
  └───────────────────────────────────────┘
```

## 📊 モニタリング構成

```
┌──────────────────────────────────────────────────────┐
│               CloudWatch Logs                        │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐    │
│  │  ECS Logs  │  │ RDS Logs   │  │  ALB Logs  │    │
│  └────────────┘  └────────────┘  └────────────┘    │
└─────────────────────┬────────────────────────────────┘
                      │
┌─────────────────────▼────────────────────────────────┐
│               CloudWatch Metrics                     │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐    │
│  │CPU使用率   │  │メモリ使用率│  │接続数      │    │
│  └────────────┘  └────────────┘  └────────────┘    │
└─────────────────────┬────────────────────────────────┘
                      │
┌─────────────────────▼────────────────────────────────┐
│               CloudWatch Alarms                      │
│  ┌──────────────────────────────────────────┐       │
│  │ CPU > 80%   → アラート発動               │       │
│  │ Memory > 80% → アラート発動              │       │
│  │ Tasks = 0   → 緊急アラート               │       │
│  └────────────────┬─────────────────────────┘       │
└───────────────────┼──────────────────────────────────┘
                    │
┌───────────────────▼──────────────────────────────────┐
│                    SNS Topic                         │
│             (メール通知 + Slack連携)                 │
└──────────────────────────────────────────────────────┘
```

## 🔄 バックアップ＆リカバリー

```
┌──────────────────────────────────────────────┐
│          RDS PostgreSQL                      │
│  ┌────────────────────────────────────┐     │
│  │        Production Database         │     │
│  └──────────┬────────────┬────────────┘     │
└─────────────┼────────────┼───────────────────┘
              │            │
    ┌─────────┘            └─────────┐
    │                                 │
┌───▼────────────────┐    ┌──────────▼──────────┐
│ Automated Backups  │    │  Manual Snapshots   │
│ (7-30 days)        │    │  (User-initiated)   │
│ ・毎日自動          │    │  ・重要変更前       │
│ ・ポイントインタイム │    │  ・長期保存         │
└───┬────────────────┘    └──────────┬──────────┘
    │                                 │
    └──────────┬──────────────────────┘
               │
    ┌──────────▼──────────┐
    │    AWS Backup       │
    │  ・一元管理          │
    │  ・クロスリージョン  │
    │  ・コンプライアンス  │
    └─────────────────────┘
```

## 🌍 マルチAZ構成（本番環境）

```
┌────────────────────────────────────────────────────────┐
│                    AWS Region                          │
│               (ap-northeast-1 東京)                     │
│                                                         │
│  ┌────────────────────┐    ┌────────────────────┐     │
│  │  Availability      │    │  Availability      │     │
│  │  Zone 1a           │    │  Zone 1c           │     │
│  │                    │    │                    │     │
│  │  ┌──────────┐      │    │  ┌──────────┐      │     │
│  │  │   ALB    │◄─────┼────┼─►│   ALB    │      │     │
│  │  └────┬─────┘      │    │  └────┬─────┘      │     │
│  │       │            │    │       │            │     │
│  │  ┌────▼─────┐      │    │  ┌────▼─────┐      │     │
│  │  │ECS Task 1│      │    │  │ECS Task 2│      │     │
│  │  └────┬─────┘      │    │  └────┬─────┘      │     │
│  │       │            │    │       │            │     │
│  │  ┌────▼─────┐      │    │  ┌────▼─────┐      │     │
│  │  │   RDS    │◄─────┼────┼─►│   RDS    │      │     │
│  │  │ Primary  │ 同期  │    │  │ Standby  │      │     │
│  │  └──────────┘      │    │  └──────────┘      │     │
│  │                    │    │                    │     │
│  └────────────────────┘    └────────────────────┘     │
│                                                         │
│  障害発生時は自動でフェイルオーバー                    │
│  RTO (目標復旧時間): 約2-5分                           │
│  RPO (目標復旧時点): 0秒（同期レプリケーション）       │
└────────────────────────────────────────────────────────┘
```

## 💰 コスト最適化のポイント

### 開発環境での節約術

```
┌──────────────────────────────────────────────────────┐
│ 節約ポイント                  月額コスト              │
├──────────────────────────────────────────────────────┤
│ 1. NAT Gateway無効化          -$30 → VPC Endpoints    │
│ 2. RDS シングルAZ             -$30 (Multi-AZ分)       │
│ 3. ECS 最小スペック           -$20 (大きいサイズ分)   │
│ 4. CloudWatch 最小ログ        -$10 (詳細ログ分)       │
│ 5. 夜間スケールダウン         -$15 (8時間停止)        │
├──────────────────────────────────────────────────────┤
│ 合計節約額                    約 $105/月              │
└──────────────────────────────────────────────────────┘
```

### 本番環境での最適化

```
┌──────────────────────────────────────────────────────┐
│ 最適化手法                    効果                    │
├──────────────────────────────────────────────────────┤
│ 1. Savings Plans              -20% (ECS/Fargate)      │
│ 2. Reserved Instances         -40% (RDS)              │
│ 3. S3 Intelligent-Tiering     -30% (画像ストレージ)   │
│ 4. CloudFront キャッシュ      -50% (転送量)           │
│ 5. Auto Scaling               変動費最適化            │
└──────────────────────────────────────────────────────┘
```

## 📈 スケーラビリティ

```
現在の構成              →  中規模              →  大規模
──────────────────────────────────────────────────────
ECS: 1-2タスク          →  2-10タスク          →  10-50タスク
RDS: db.t3.micro        →  db.t3.medium        →  db.r5.xlarge
ALB: 1台                →  1台                 →  複数リージョン
Cache: なし             →  Redis (ElastiCache) →  CDN + Redis
                                                  + CloudFront
```

## 🎯 次のステップ

1. **CDNの追加** - CloudFront で画像配信を高速化
2. **キャッシュ層** - Redis で API レスポンスをキャッシュ
3. **検索機能** - OpenSearch で全文検索
4. **CI/CD** - GitHub Actions で自動デプロイ
5. **マルチリージョン** - グローバル展開

---

このアーキテクチャは、小規模スタートから大規模サービスまでスケールできる設計になっています！


